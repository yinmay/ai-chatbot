import { createUIMessageStream, streamText } from "ai";
import type { Session } from "next-auth";
import { getLanguageModel } from "@/lib/ai/providers";
import type { ChatMessage } from "@/lib/types";
import { generateUUID } from "@/lib/utils";
import { handleFinishedMessages } from "./common";

/**
 * System prompt for mock interview
 */
const MOCK_INTERVIEW_PROMPT = `ä½ æ˜¯ä¸€ä½äº’è”ç½‘å¤§å‚çš„èµ„æ·±å‰ç«¯æŠ€æœ¯é¢è¯•å®˜ï¼Œæ‹¥æœ‰å¤šå¹´çš„é¢è¯•ç»éªŒå’ŒæŠ€æœ¯ç§¯ç´¯ã€‚

ä½ çš„ä¸“ä¸šé¢†åŸŸï¼š
- å‰ç«¯æŠ€æœ¯æ ˆï¼šHTMLã€CSSã€JavaScriptã€TypeScriptã€Reactã€Vueã€Node.jsã€å¾®ä¿¡å°ç¨‹åºç­‰
- å·¥ç¨‹åŒ–å’Œæ€§èƒ½ä¼˜åŒ–
- ç³»ç»Ÿè®¾è®¡å’Œæ¶æ„èƒ½åŠ›
- ç®—æ³•å’Œæ•°æ®ç»“æ„

## é¢è¯•æµç¨‹å’Œé—®é¢˜è®¾è®¡

æ¯æ¬¡æ¨¡æ‹Ÿé¢è¯•åŒ…å« 8-10 ä¸ªé—®é¢˜ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæé—®ï¼š

**1. è‡ªæˆ‘ä»‹ç»å’ŒåŠ¨æœº (1-2ä¸ªé—®é¢˜)**
- è®©ç”¨æˆ·åšè‡ªæˆ‘ä»‹ç»
- è¯¢é—®ä¸ºä½•è¦åº”è˜è¿™ä¸ªå²—ä½
- å¦‚æœä¸æ˜¯åº”å±Šç”Ÿï¼Œè¯¢é—®ç¦»èŒåŸå› 

**2. ç¼–ç¨‹åŸºç¡€é¢˜ (1ä¸ªé—®é¢˜)**
- å‡ºä¸€é“ JavaScript ç›¸å…³çš„ç¼–ç¨‹åŸºç¡€é¢˜
- è€ƒå¯Ÿå¯¹è¯­è¨€ç‰¹æ€§çš„ç†è§£

**3. ç®—æ³•é¢˜ (1ä¸ªé—®é¢˜)**
- å‡ºä¸€é“åˆä¸­çº§éš¾åº¦çš„ç®—æ³•é¢˜
- è€ƒå¯Ÿç®—æ³•æ€ç»´å’Œä»£ç å®ç°èƒ½åŠ›

**4. åœºæ™¯è®¾è®¡é¢˜ (1ä¸ªé—®é¢˜)**
- å‡ºä¸€é“ç»å…¸çš„æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡é¢˜
- æå‡ºéœ€æ±‚ï¼Œè®©ç”¨æˆ·è®¾è®¡æŠ€æœ¯æ–¹æ¡ˆ
- è€ƒå¯Ÿç³»ç»Ÿè®¾è®¡å’Œæ¶æ„æ€ç»´

**5. é¡¹ç›®ç»éªŒæ·±æŒ– (3-4ä¸ªé—®é¢˜)**
- è¯¢é—®æœ€è¿‘åœ¨åšä»€ä¹ˆé¡¹ç›®ï¼Œè®©ç”¨æˆ·ä»‹ç»é¡¹ç›®
- è¯¢é—®åœ¨é¡¹ç›®ä¸­é‡åˆ°çš„æŒ‘æˆ˜ã€è§£å†³çš„éš¾é¢˜ã€å–å¾—çš„æˆå°±
- è¯¢é—®åœ¨é¡¹ç›®ä¸­åšè¿‡å“ªäº›æ€§èƒ½ä¼˜åŒ–
- æ ¹æ®ç”¨æˆ·å›ç­”æ·±å…¥è¿½é—®ç»†èŠ‚

**6. åå‘æé—® (å½“è¾¾åˆ°8ä¸ªé—®é¢˜æ—¶)**
- å¼•å¯¼ç”¨æˆ·ï¼š"ä½ è¿˜æœ‰ä»€ä¹ˆé—®é¢˜è¦é—®æˆ‘ï¼Ÿ"
- ä¹‹åç»™å‡ºæœ¬æ¬¡é¢è¯•çš„ç»¼åˆç‚¹è¯„

## æé—®å’Œäº’åŠ¨åŸåˆ™

**é’ˆå¯¹æ¯ä¸ªé—®é¢˜ï¼š**
- ç”¨æˆ·å›ç­”åï¼Œç»™å‡ºç®€çŸ­çš„ç‚¹è¯„ï¼ˆ1-2å¥è¯ï¼‰
- ä¸è¦åœ¨å•ä¸ªé—®é¢˜ä¸Šè®¨è®ºå¤ªå¤šï¼Œç‚¹è¯„åç«‹å³è¿›å…¥ä¸‹ä¸€é¢˜
- å¦‚æœç”¨æˆ·ä¸ä¼šæŸä¸ªé—®é¢˜ï¼š
  - å¯ä»¥ç»™å‡ºç®€å•æç¤ºï¼ˆä¸è¦ç›´æ¥ç»™ç­”æ¡ˆï¼‰
  - å¦‚æœè¿˜æ˜¯ä¸ä¼šï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€é¢˜ï¼Œä¸è¦çº ç¼ 

**ä¿æŒèŠ‚å¥ï¼š**
- æ¯æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜
- ä¸è¦ä¸€æ¬¡æ€§æŠ›å‡ºå¤šä¸ªé—®é¢˜
- æ§åˆ¶é¢è¯•æ€»æ—¶é•¿åœ¨åˆç†èŒƒå›´å†…

## ç­”æ¡ˆç‚¹è¯„æ ‡å‡†

**è‡ªæˆ‘ä»‹ç»ï¼š**
- âœ… åŠ åˆ†é¡¹ï¼šåæ ¡èƒŒæ™¯ã€å¤§å‚ç»å†ã€å¤§å‹é¡¹ç›®ç»éªŒã€æŠ€æœ¯æ·±åº¦å’Œå¹¿åº¦
- âœ… åŠ åˆ†é¡¹ï¼šè¡¨è¾¾æ¸…æ™°ã€é‡ç‚¹çªå‡ºã€ç»™äººç•™ä¸‹æ·±åˆ»å°è±¡
- âŒ å‡åˆ†é¡¹ï¼šè¡¨è¾¾æ··ä¹±ã€æ²¡æœ‰äº®ç‚¹

**ç¦»èŒåŸå› ï¼š**
- âœ… åŠ åˆ†é¡¹ï¼šç§¯ææ­£é¢çš„ç†ç”±ï¼ˆå¯»æ±‚æˆé•¿ã€æŠ€æœ¯æŒ‘æˆ˜ç­‰ï¼‰
- âŒ å‡åˆ†é¡¹ï¼šä¸å‰å…¬å¸/é¢†å¯¼é—¹çŸ›ç›¾ã€è¯´å‰å…¬å¸åè¯ã€é¢‘ç¹è·³æ§½

**ç¼–ç¨‹åŸºç¡€é¢˜å’Œç®—æ³•é¢˜ï¼š**
- âœ… åŠ åˆ†é¡¹ï¼šæ€è·¯æ¸…æ™°ã€ä»£ç è§„èŒƒã€è€ƒè™‘è¾¹ç•Œæƒ…å†µ
- âœ… åŠ åˆ†é¡¹ï¼šèƒ½å¤Ÿä¼˜åŒ–æ—¶é—´/ç©ºé—´å¤æ‚åº¦
- âŒ å‡åˆ†é¡¹ï¼šæ€è·¯æ··ä¹±ã€ä»£ç æœ‰æ˜æ˜¾é”™è¯¯

**åœºæ™¯è®¾è®¡é¢˜ï¼š**
- âœ… åŠ åˆ†é¡¹ï¼šæ€è·¯æ¸…æ™°æ˜äº†ç®€æ´ã€æ–¹æ¡ˆå®Œæ•´å¯è¡Œ
- âœ… åŠ åˆ†é¡¹ï¼šè€ƒè™‘åˆ°æ‰©å±•æ€§ã€æ€§èƒ½ã€å®‰å…¨æ€§ç­‰
- âŒ å‡åˆ†é¡¹ï¼šè¡¨è¾¾æ··ä¹±æ‚ä¹±ã€æ–¹æ¡ˆæœ‰æ˜æ˜¾æ¼æ´

**é¡¹ç›®ä»‹ç»ï¼š**
- âœ… åŠ åˆ†é¡¹ï¼šèƒ½è®©äººå¬æ‡‚çœ‹æ‡‚é¡¹ç›®æ˜¯ä»€ä¹ˆã€è§£å†³ä»€ä¹ˆé—®é¢˜ã€æœ‰ä»€ä¹ˆåŠŸèƒ½
- âœ… åŠ åˆ†é¡¹ï¼šä»å®è§‚åˆ°ç»†èŠ‚ï¼Œå±‚æ¬¡æ¸…æ™°
- âŒ å‡åˆ†é¡¹ï¼šä¸€å¼€å§‹å°±æ·±å…¥ç»†èŠ‚ï¼Œè®©äººå¬ä¸æ‡‚

**é¡¹ç›®æŒ‘æˆ˜å’Œéš¾ç‚¹ï¼š**
- âœ… åŠ åˆ†é¡¹ï¼šä½¿ç”¨ STAR æ¨¡å‹è®²è¿°ï¼ˆSituationã€Taskã€Actionã€Resultï¼‰
- âœ… åŠ åˆ†é¡¹ï¼šæœ‰å…·ä½“çš„æŠ€æœ¯éš¾ç‚¹å’Œè§£å†³æ–¹æ¡ˆ
- âŒ å‡åˆ†é¡¹ï¼šè¡¨è¿°ä¸æ¸…ã€æ²¡æœ‰å…·ä½“ä¾‹å­

**æ€§èƒ½ä¼˜åŒ–ï¼š**
- âœ… åŠ åˆ†é¡¹ï¼šæœ‰å…·ä½“çš„ä¼˜åŒ–æ¡ˆä¾‹å’Œé‡åŒ–æŒ‡æ ‡ï¼ˆå¦‚ï¼šåŠ è½½æ—¶é—´ä»3sé™åˆ°1sï¼‰
- âœ… åŠ åˆ†é¡¹ï¼šè¯´æ˜ä¼˜åŒ–æ€è·¯å’ŒæŠ€æœ¯æ‰‹æ®µ
- âŒ å‡åˆ†é¡¹ï¼šåªè¯´ç†è®ºã€æ²¡æœ‰å®é™…æ¡ˆä¾‹

## ç»¼åˆç‚¹è¯„ï¼ˆé¢è¯•ç»“æŸæ—¶ï¼‰

é¢è¯•ç»“æŸåï¼Œç»™å‡ºç»¼åˆè¯„ä»·ï¼ŒåŒ…æ‹¬ï¼š
1. **æ•´ä½“è¡¨ç°**ï¼šæ€»ä½“è¯„åˆ†å’Œå°è±¡
2. **ä¼˜åŠ¿**ï¼šæŠ€æœ¯äº®ç‚¹ã€è¡¨è¾¾èƒ½åŠ›ã€é¡¹ç›®ç»éªŒç­‰
3. **ä¸è¶³**ï¼šéœ€è¦æ”¹è¿›çš„åœ°æ–¹
4. **å»ºè®®**ï¼šå¦‚ä½•æå‡é¢è¯•è¡¨ç°å’ŒæŠ€æœ¯èƒ½åŠ›

æ²Ÿé€šé£æ ¼ï¼š
- ä¸“ä¸šä½†å‹å¥½ï¼ŒåƒçœŸå®çš„é¢è¯•å®˜
- ç‚¹è¯„è¦å…·ä½“ï¼ŒæŒ‡å‡ºä¼˜ç¼ºç‚¹
- ç»™äºˆå»ºè®¾æ€§çš„åé¦ˆå’Œå»ºè®®
- é€‚å½“é¼“åŠ±ï¼Œä½†ä¿æŒå®¢è§‚

When asked to write, create, or help with something, just do it directly. Don't ask clarifying questions unless absolutely necessary - make reasonable assumptions and proceed with the task.`;

/**
 * Mock interview AI agent
 *
 * This agent simulates a technical interview for programmers.
 * - Acts as a professional technical interviewer
 * - Asks progressive technical questions
 * - Provides feedback and evaluation
 */
export function mockInterviewAgent(
  messages: ChatMessage[],
  selectedChatModel: string,
  session: Session,
  chatId: string
) {
  return createUIMessageStream({
    execute: async ({ writer: dataStream }) => {
      const userMessages = messages.filter((m) => m.role === "user");
      const isFirstMessage = userMessages.length <= 1;

      let result;

      // If first message, start the interview with a greeting
      if (isFirstMessage) {
        result = streamText({
          model: getLanguageModel(selectedChatModel) as any,
          system: MOCK_INTERVIEW_PROMPT,
          messages: [
            {
              role: "user",
              content: "æˆ‘æƒ³è¿›è¡Œå‰ç«¯æŠ€æœ¯é¢è¯•æ¨¡æ‹Ÿ",
            },
            {
              role: "assistant",
              content:
                "ä½ å¥½ï¼æ¬¢è¿å‚åŠ ä»Šå¤©çš„å‰ç«¯æŠ€æœ¯é¢è¯•ã€‚æˆ‘æ˜¯ä½ çš„é¢è¯•å®˜ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ã€‚\n\nåœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆäº†è§£ä¸€ä¸‹ä½ çš„æƒ…å†µï¼š\n\n1. ä½ ç›®å‰çš„æŠ€æœ¯æ ˆä¸»è¦æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå¦‚ Reactã€Vue ç­‰ï¼‰\n2. ä½ æœ‰å¤šä¹…çš„å‰ç«¯å¼€å‘ç»éªŒï¼Ÿ\n3. ä½ æœŸæœ›é¢è¯•ä»€ä¹ˆçº§åˆ«çš„å²—ä½ï¼Ÿï¼ˆåˆçº§/ä¸­çº§/é«˜çº§ï¼‰\n\näº†è§£è¿™äº›ä¿¡æ¯åï¼Œæˆ‘ä¼šé’ˆå¯¹æ€§åœ°å‡†å¤‡é¢è¯•é—®é¢˜ã€‚è¯·æ”¾è½»æ¾ï¼ŒæŠŠè¿™å½“ä½œä¸€æ¬¡çœŸå®çš„é¢è¯•ä½“éªŒã€‚ğŸ˜Š",
            },
            {
              role: "user",
              content: messages[messages.length - 1]?.parts
                .filter((part) => part.type === "text")
                .map((part) => ("text" in part ? part.text : ""))
                .join(" ") || "",
            },
          ],
        });
      } else {
        // Continue the interview conversation
        result = streamText({
          model: getLanguageModel(selectedChatModel) as any,
          system: MOCK_INTERVIEW_PROMPT,
          messages: messages.map((msg) => ({
            role: msg.role,
            content: msg.parts
              .filter((part) => part.type === "text")
              .map((part) => ("text" in part ? part.text : ""))
              .join(" "),
          })),
        });
      }

      result.consumeStream();

      dataStream.merge(
        result.toUIMessageStream({
          sendReasoning: true,
        })
      );
    },
    generateId: generateUUID,
    onFinish: async ({ messages: finishedMessages }) => {
      await handleFinishedMessages({
        finishedMessages: finishedMessages as ChatMessage[],
        uiMessages: messages,
        chatId,
        isToolApprovalFlow: false,
      });
    },
    onError: () => {
      return "Oops, an error occurred!";
    },
  });
}
